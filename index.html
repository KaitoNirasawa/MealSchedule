<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>家族の食事予定</title>
<style>
  body { font-family: sans-serif; margin: 10px; font-size: 16px; }
  table { border-collapse: collapse; width: 100%; font-size: 14px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #f0f0f0; }
  button, select { font-size: 16px; }
  .hidden { display: none; }
  .note-button { margin-left: 4px; font-size: 12px; cursor: pointer; }
  .detail-row { background: #fafafa; }
  .detail-box { padding: 10px; font-size: 14px; text-align: left; }
  @media screen and (max-width: 600px) {
    table, thead, tbody, th, td, tr { display: block; }
    thead tr { display: none; }
    tr { margin-bottom: 10px; border: 1px solid #ccc; padding: 6px; }
    td { border: none; padding: 4px 8px; position: relative; text-align: left; }
    td::before { content: attr(data-label); font-weight: bold; display: block; }
  }
</style>
</head>
<body>
  <h2>家族の食事予定（10日分）</h2>

  <label>名前:
    <select id="nameSelect">
      <option value="Kと">Kと</option>
      <option value="Tし">Tし</option>
      <option value="Aり">Aり</option>
      <option value="Yこ">Yこ</option>
    </select>
  </label>
  <button id="registerBtn" onclick="toggleRegistration()">登録</button>
  <button id="saveBtn" class="hidden" onclick="saveData()">保存</button>

  <table id="mealTable" aria-label="食事予定テーブル">
    <thead>
      <tr>
        <th>日付</th>
        <th>朝</th>
        <th>昼</th>
        <th>夜</th>
      </tr>
    </thead>
    <tbody id="mealBody"></tbody>
  </table>

  <script>
    const API_URL = 'ここにGoogle Apps ScriptのウェブアプリURLを貼ってください';
    const members = ['Kと', 'Tし', 'Aり', 'Yこ'];
    let data = {};  // { '日付': { 朝: [], 昼: [], 夜: [], 備考: {} } }
    let isRegistering = false;
    let openDetailDate = null;

    // 日付文字列を作成（例：7/11（木））
    function getDateString(offset) {
      const date = new Date();
      date.setDate(date.getDate() + offset);
      const wdays = ['日', '月', '火', '水', '木', '金', '土'];
      return `${date.getMonth() + 1}/${date.getDate()}（${wdays[date.getDay()]}）`;
    }

    // データ取得
    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('データ取得失敗');
        const rows = await res.json();
        data = {};
        rows.forEach(({date, meal, name, note}) => {
          if (!data[date]) data[date] = { 朝: [], 昼: [], 夜: [], 備考: {} };
          data[date][meal].push(name);
          if (note) data[date].備考[`${date}_${meal}_${name}`] = note;
        });
        renderTable();
      } catch (err) {
        alert('データの取得に失敗しました。');
        console.error(err);
      }
    }

    // 保存処理
    async function saveData() {
      const name = document.getElementById('nameSelect').value;
      const checkboxes = document.querySelectorAll('input[type="checkbox"][data-date]');

      // 登録者の既存データを一旦クリア
      for (let i = 0; i < 10; i++) {
        const dateStr = getDateString(i);
        ['朝', '昼', '夜'].forEach(meal => {
          const idx = data[dateStr][meal].indexOf(name);
          if (idx !== -1) data[dateStr][meal].splice(idx, 1);
          const noteKey = `${dateStr}_${meal}_${name}`;
          delete data[dateStr].備考[noteKey];
        });
      }

      // チェックされた箇所を追加
      checkboxes.forEach(cb => {
        if (cb.checked) {
          const date = cb.dataset.date;
          const meal = cb.dataset.meal;
          const noteKey = `${date}_${meal}_${name}`;
          if (!data[date][meal].includes(name)) data[date][meal].push(name);
          const note = cb.dataset.note || '';
          if (note) data[date].備考[noteKey] = note;
        }
      });

      // 送信用データに変換
      const allRows = [];
      Object.keys(data).forEach(date => {
        ['朝', '昼', '夜'].forEach(meal => {
          data[date][meal].forEach(name => {
            const noteKey = `${date}_${meal}_${name}`;
            allRows.push({ date, meal, name, note: data[date].備考[noteKey] || '' });
          });
        });
      });

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(allRows)
        });
        if (!res.ok) throw new Error('保存に失敗しました');
        const resJson = await res.json();
        if (resJson.result !== 'success') throw new Error('サーバーエラー');
        alert('保存しました');
        toggleRegistration(false);
        fetchData();
      } catch (err) {
        alert(err.message || '保存時にエラーが発生しました');
        console.error(err);
      }
    }

    // テーブル描画
    function renderTable() {
      const tbody = document.getElementById('mealBody');
      tbody.innerHTML = '';
      const name = document.getElementById('nameSelect').value;

      for (let i = 0; i < 10; i++) {
        const dateStr = getDateString(i);
        if (!data[dateStr]) {
          data[dateStr] = { 朝: [], 昼: [], 夜: [], 備考: {} };
        }
        const row = document.createElement('tr');

        if (isRegistering) {
          // チェックボックス＋備考ボタン表示
          const createCell = meal => {
            const checked = data[dateStr][meal].includes(name) ? 'checked' : '';
            return `
              <td data-label="${meal}">
                <input type="checkbox" data-date="${dateStr}" data-meal="${meal}" ${checked} />
                <button class="note-button" onclick="openNotePopup('${dateStr}','${meal}','${name}')">備考</button>
              </td>`;
          };

          row.innerHTML = `<td data-label="日付">${dateStr}</td>` +
            createCell('朝') + createCell('昼') + createCell('夜');
        } else {
          row.innerHTML = `
            <td data-label="日付"><button onclick="toggleDetail('${dateStr}')">${dateStr}</button></td>
            <td data-label="朝">${data[dateStr].朝.length}人</td>
            <td data-label="昼">${data[dateStr].昼.length}人</td>
            <td data-label="夜">${data[dateStr].夜.length}人</td>
          `;
        }
        tbody.appendChild(row);

        // 詳細行（登録モードでないときのみ表示）
        if (openDetailDate === dateStr && !isRegistering) {
          const detailRow = document.createElement('tr');
          detailRow.className = 'detail-row';
          detailRow.innerHTML = `<td colspan="4" class="detail-box">${generateDetailHtml(dateStr)}</td>`;
          tbody.appendChild(detailRow);
        }
      }
    }

    // 登録モード切替
    function toggleRegistration(forceOff) {
      if (typeof forceOff === 'boolean') {
        isRegistering = !forceOff;
      } else {
        isRegistering = !isRegistering;
      }
      document.getElementById('registerBtn').
